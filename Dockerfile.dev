FROM node:22.20-alpine
# Build-time arguments for Next.js public variables
ARG NEXT_PUBLIC_VERSION
ARG NEXT_PUBLIC_BACKEND_URL
ARG NEXT_PUBLIC_UPLOAD_DIRECTORY
ARG NEXT_PUBLIC_UPLOAD_STATIC_DIRECTORY
ARG NEXT_PUBLIC_DISCORD_SUPPORT
ARG NEXT_PUBLIC_POLOTNO
ARG NEXT_PUBLIC_POSTIZ_OAUTH_DISPLAY_NAME
ARG NEXT_PUBLIC_POSTIZ_OAUTH_LOGO_URL
ARG NEXT_PUBLIC_SENTRY_DSN
ARG NEXT_PUBLIC_TOLT
ARG NEXT_PUBLIC_FACEBOOK_PIXEL
ARG POSTIZ_GENERIC_OAUTH
ARG IS_GENERAL
ARG STORAGE_PROVIDER
ARG FRONTEND_URL

# Set as environment variables for Next.js build
ENV NEXT_PUBLIC_VERSION=$NEXT_PUBLIC_VERSION
ENV NEXT_PUBLIC_BACKEND_URL=$NEXT_PUBLIC_BACKEND_URL
ENV NEXT_PUBLIC_UPLOAD_DIRECTORY=$NEXT_PUBLIC_UPLOAD_DIRECTORY
ENV NEXT_PUBLIC_UPLOAD_STATIC_DIRECTORY=$NEXT_PUBLIC_UPLOAD_STATIC_DIRECTORY
ENV NEXT_PUBLIC_DISCORD_SUPPORT=$NEXT_PUBLIC_DISCORD_SUPPORT
ENV NEXT_PUBLIC_POLOTNO=$NEXT_PUBLIC_POLOTNO
ENV NEXT_PUBLIC_POSTIZ_OAUTH_DISPLAY_NAME=$NEXT_PUBLIC_POSTIZ_OAUTH_DISPLAY_NAME
ENV NEXT_PUBLIC_POSTIZ_OAUTH_LOGO_URL=$NEXT_PUBLIC_POSTIZ_OAUTH_LOGO_URL
ENV NEXT_PUBLIC_SENTRY_DSN=$NEXT_PUBLIC_SENTRY_DSN
ENV NEXT_PUBLIC_TOLT=$NEXT_PUBLIC_TOLT
ENV NEXT_PUBLIC_FACEBOOK_PIXEL=$NEXT_PUBLIC_FACEBOOK_PIXEL
# POSTIZ_GENERIC_OAUTH: Leave unset (empty) to disable generic OAuth and show Google Sign-In
ENV POSTIZ_GENERIC_OAUTH=${POSTIZ_GENERIC_OAUTH:-}
ENV IS_GENERAL=$IS_GENERAL
ENV STORAGE_PROVIDER=$STORAGE_PROVIDER
ENV FRONTEND_URL=$FRONTEND_URL

RUN apk add --no-cache g++ make py3-pip bash nginx
RUN adduser -D -g 'www' www
RUN mkdir /www
RUN chown -R www:www /var/lib/nginx
RUN chown -R www:www /www


RUN npm --no-update-notifier --no-fund --global install pnpm@10.6.1 pm2

WORKDIR /app

COPY . /app
COPY var/docker/nginx.conf /etc/nginx/nginx.conf

RUN pnpm install
RUN NODE_OPTIONS="--max-old-space-size=4096" pnpm run build

CMD ["sh", "-c", "nginx && pnpm run pm2"]
